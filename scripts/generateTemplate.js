const XLSX = require('xlsx');
const path = require('path');

// テンプレートデータを作成
function generateTemplate() {
  const workbook = XLSX.utils.book_new();

  // ===== データ入力シート =====
  // 回数は自動計算されるのでテンプレートから削除
  const dataHeaders = [
    'Instagram名',
    'Instagram URL',
    'TikTok名',
    'TikTok URL',
    '品番',
    '枚数',          // 必須
    'セール日',      // 必須
    '投稿希望日',
    '投稿希望期間（開始）',
    '投稿希望期間（終了）',
    '合意日',
    '提示額（円）',
    '合意額（円）',
    '商品原価・送料（円）',
    'ステータス',
    '投稿日',
    '投稿URL',
    'いいね数',
    'コメント数',
    '備考'
  ];

  // サンプルデータ（1行目はヘッダー説明、2行目以降はサンプル）
  // 回数は自動計算されるのでテンプレートから削除
  const sampleData = [
    dataHeaders,
    [
      '@sample_influencer',
      'https://instagram.com/sample_influencer',
      '@sample_tiktok',
      'https://tiktok.com/@sample_tiktok',
      'TF-2408',
      1,
      '2024-03-01',
      '2024-03-15',
      '',
      '',
      '2024-02-20',
      30000,
      30000,
      800,
      '合意',
      '2024-03-14',
      'https://instagram.com/p/xxxxx',
      1500,
      50,
      'サンプルデータです'
    ],
    [
      '@example_user',
      'https://instagram.com/example_user',
      '',
      '',
      'BE-1205',
      2,
      '2024-04-01',
      '',
      '2024-04-01',
      '2024-04-07',
      '2024-03-25',
      50000,
      45000,
      800,
      '保留',
      '',
      '',
      '',
      '',
      '期間指定の例'
    ]
  ];

  const dataSheet = XLSX.utils.aoa_to_sheet(sampleData);

  // 列幅を設定（回数は自動計算なので削除）
  dataSheet['!cols'] = [
    { wch: 20 },  // Instagram名
    { wch: 35 },  // Instagram URL
    { wch: 20 },  // TikTok名
    { wch: 35 },  // TikTok URL
    { wch: 12 },  // 品番
    { wch: 8 },   // 枚数（必須）
    { wch: 12 },  // セール日（必須）
    { wch: 12 },  // 投稿希望日
    { wch: 18 },  // 投稿希望期間（開始）
    { wch: 18 },  // 投稿希望期間（終了）
    { wch: 12 },  // 合意日
    { wch: 12 },  // 提示額
    { wch: 12 },  // 合意額
    { wch: 18 },  // 商品原価・送料
    { wch: 10 },  // ステータス
    { wch: 12 },  // 投稿日
    { wch: 35 },  // 投稿URL
    { wch: 10 },  // いいね数
    { wch: 10 },  // コメント数
    { wch: 30 },  // 備考
  ];

  XLSX.utils.book_append_sheet(workbook, dataSheet, 'データ入力');

  // ===== 入力ルールシート =====
  const rulesData = [
    ['ギフティング案件 データ入稿ルール'],
    [''],
    ['【重要】このテンプレートを使用してデータを入力してください'],
    [''],
    ['■ 必須項目と任意項目'],
    [''],
    ['項目名', '必須/任意', '入力形式', '説明', '入力例'],
    ['Instagram名', '※どちらか必須', 'テキスト', 'インフルエンサーのInstagramアカウント名（@含む）', '@sample_influencer'],
    ['Instagram URL', '任意', 'URL', 'InstagramプロフィールのURL', 'https://instagram.com/sample'],
    ['TikTok名', '※どちらか必須', 'テキスト', 'インフルエンサーのTikTokアカウント名（@含む）', '@sample_tiktok'],
    ['TikTok URL', '任意', 'URL', 'TikTokプロフィールのURL', 'https://tiktok.com/@sample'],
    ['品番', '必須', 'テキスト', '商品の品番コード', 'TF-2408'],
    ['枚数', '★必須', '数値', '商品の数量', '1'],
    ['セール日', '★必須', '日付', '商品のセール開始日（YYYY-MM-DD形式）', '2024-03-01'],
    ['投稿希望日', '※1', '日付', '特定の投稿希望日（YYYY-MM-DD形式）', '2024-03-15'],
    ['投稿希望期間（開始）', '※1', '日付', '投稿希望期間の開始日', '2024-03-01'],
    ['投稿希望期間（終了）', '※1', '日付', '投稿希望期間の終了日', '2024-03-07'],
    ['合意日', '任意', '日付', 'インフルエンサーとの合意日', '2024-02-20'],
    ['提示額（円）', '任意', '数値', 'インフルエンサーへの提示金額', '30000'],
    ['合意額（円）', '任意', '数値', '最終的な合意金額', '30000'],
    ['商品原価・送料（円）', '任意', '数値', '商品原価と送料の合計（未入力時は800円）', '800'],
    ['ステータス', '任意', '選択', '案件のステータス（下記参照）', '合意'],
    ['投稿日', '※2', '日付', '実際の投稿日', '2024-03-14'],
    ['投稿URL', '※2', 'URL', '投稿のURL', 'https://instagram.com/p/xxxxx'],
    ['いいね数', '※2', '数値', '投稿のいいね数', '1500'],
    ['コメント数', '※2', '数値', '投稿のコメント数', '50'],
    ['備考', '※2', 'テキスト', '自由記述のメモ', '特記事項など'],
    [''],
    ['★必須: 必ず入力が必要な項目です'],
    ['※どちらか必須: Instagram名またはTikTok名のどちらか一方は必ず入力してください'],
    ['※1: 投稿希望日と投稿希望期間は排他的です。特定日の場合は「投稿希望日」のみ、期間指定の場合は「開始」「終了」を入力'],
    ['※2: ステータスが「合意」の場合、最終的に入力必須です（システムから通知されます）'],
    [''],
    ['【注意】回数は同一インフルエンサーの案件数から自動計算されるため、テンプレートには含まれていません'],
    [''],
    ['■ ステータスの入力値'],
    [''],
    ['入力値', '意味'],
    ['保留', '交渉中・検討中'],
    ['合意', 'インフルエンサーと合意済み'],
    ['不合意', '条件が合わず不成立'],
    ['キャンセル', '案件がキャンセルされた'],
    ['無視', '分析対象外とする案件'],
    [''],
    ['■ 日付の入力形式'],
    [''],
    ['形式', '例'],
    ['YYYY-MM-DD', '2024-03-15'],
    ['YYYY/MM/DD', '2024/03/15'],
    ['MM/DD/YYYY', '03/15/2024'],
    [''],
    ['※Excelの日付形式でも自動認識されます'],
    [''],
    ['■ 注意事項'],
    [''],
    ['1. ヘッダー行（1行目）は削除・変更しないでください'],
    ['2. サンプルデータ（2行目以降）は削除してから入力してください'],
    ['3. 空白行があっても問題ありません'],
    ['4. URLは完全な形式で入力してください（https://から始まる）'],
    ['5. 金額にはカンマや円記号を入れないでください（数値のみ）'],
    ['6. 同じインフルエンサーの複数案件は、それぞれ別の行に入力してください'],
    [''],
    ['■ ブランドについて'],
    [''],
    ['ブランドはインポート時に自動設定されます。'],
    ['インポート前にサイドバーで対象ブランド（TL/BE/AM）を選択してください。'],
  ];

  const rulesSheet = XLSX.utils.aoa_to_sheet(rulesData);

  // 列幅を設定
  rulesSheet['!cols'] = [
    { wch: 25 },
    { wch: 15 },
    { wch: 15 },
    { wch: 50 },
    { wch: 35 },
  ];

  XLSX.utils.book_append_sheet(workbook, rulesSheet, '入力ルール');

  // ===== ステータス一覧シート（データ検証用） =====
  const statusData = [
    ['ステータス一覧'],
    ['保留'],
    ['合意'],
    ['不合意'],
    ['キャンセル'],
    ['無視'],
  ];

  const statusSheet = XLSX.utils.aoa_to_sheet(statusData);
  XLSX.utils.book_append_sheet(workbook, statusSheet, 'マスタ');

  // ファイルを出力
  const outputPath = path.join(__dirname, '../public/templates/gifting_import_template.xlsx');
  XLSX.writeFile(workbook, outputPath);

  console.log('テンプレートを作成しました:', outputPath);
}

generateTemplate();
